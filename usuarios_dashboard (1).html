<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Personal DIMAO</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .stat-card {
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15) !important;
    }
    .stat-card.active {
      border: 3px solid #3498db !important;
    }
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    .mini-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .tipo-trabajo-badge {
      font-size: 0.75rem;
      font-weight: 600;
    }
    .breadcrumb {
      background: transparent;
      padding: 0;
      margin-bottom: 1rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    .stats-card {
      border-radius: 8px;
      padding: 1rem;
      color: white;
      text-align: center;
    }
    .stats-card .number {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .stats-card .label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .accordion-button:not(.collapsed) {
      background-color: #e7f1ff;
      color: #0c63e4;
    }
    .department-chart {
      height: 250px;
    }
  </style>
</head>
<body>
  <div class="container-fluid py-3">
   <!-- Header -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h1 class="h3 mb-1">DASHBOARD - PERSONAL DIMAO</h1>
            <p class="text-muted mb-0">Distribución del personal por categoría laboral</p>
          </div>
          <div class="col-md-6 text-end">
            <button class="btn btn-primary" onclick="load_Personal_DIMAO()">
              <i class="bi bi-arrow-clockwise"></i> Actualizar Datos
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Estadísticas de Personal -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Estadísticas de Personal</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Total Personal -->
          <div class="col-md-3 mb-3">
            <div class="card stat-card bg-primary text-white">
              <div class="card-body text-center">
                <i class="bi bi-people-fill display-4 mb-2"></i>
                <h2 id="totalPersonal">0</h2>
                <p class="mb-0">TOTAL PERSONAL</p>
              </div>
            </div>
          </div>
          
          <!-- Total Departamentos -->
          <div class="col-md-3 mb-3">
            <div class="card stat-card bg-success text-white">
              <div class="card-body text-center">
                <i class="bi bi-building display-4 mb-2"></i>
                <h2 id="totalDepartamentos">0</h2>
                <p class="mb-0">DEPARTAMENTOS</p>
              </div>
            </div>
          </div>
          
          <!-- Total Tipos de Contrato -->
          <div class="col-md-3 mb-3">
            <div class="card stat-card bg-warning text-dark">
              <div class="card-body text-center">
                <i class="bi bi-file-earmark-text display-4 mb-2"></i>
                <h2 id="totalContratos">0</h2>
                <p class="mb-0">TIPOS DE CONTRATO</p>
              </div>
            </div>
          </div>
          
          <!-- Total Tipos de Trabajo -->
          <div class="col-md-3 mb-3">
            <div class="card stat-card bg-info text-white">
              <div class="card-body text-center">
                <i class="bi bi-briefcase display-4 mb-2"></i>
                <h2 id="totalTrabajos">0</h2>
                <p class="mb-0">TIPOS DE TRABAJO</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="card-title mb-0">Distribución por Tipo de Trabajo</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="tipoTrabajoChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="card-title mb-0" id="miniListTitle">Personal - <span id="currentCategory">Todos</span></h5>
          </div>
          <div class="card-body p-0">
            <div class="mini-list" id="miniList">
              <!-- La mini lista se cargará dinámicamente -->
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="card-title mb-0">Distribución por Tipo de Contrato</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="tipoContratoChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Gráficos Adicionales -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="card-title mb-0">Distribución por Departamento</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="departamentoChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="card-title mb-0">Distribución por Turno</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="turnoChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-header">
            <h5 class="card-title mb-0">Rango de Edad</h5>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="edadChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Análisis por Departamento -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Análisis Detallado por Departamento</h5>
      </div>
      <div class="card-body">
        <div class="accordion" id="departamentosAccordion">
          <!-- Los acordeones se generarán dinámicamente -->
        </div>
      </div>
    </div>

    <!-- Estadísticas por Departamento -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Personal por Departamento</h5>
      </div>
      <div class="card-body">
        <div class="stats-grid" id="departamentosStats">
          <!-- Las estadísticas por departamento se cargarán dinámicamente -->
        </div>
      </div>
    </div>

    <!-- Estadísticas por Tipo de Contrato -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">Personal por Tipo de Contrato</h5>
      </div>
      <div class="card-body">
        <div class="stats-grid" id="contratosStats">
          <!-- Las estadísticas por tipo de contrato se cargarán dinámicamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay de carga -->
  <div class="modal fade" id="overlay" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 bg-transparent">
        <div class="modal-body text-center text-white">
          <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
          <div id="overlayMessage" class="fs-5">Cargando...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const WEB_PERSONAL = "https://script.google.com/macros/s/AKfycbxbefUBRgNj46KdM4_ZSO1C-tSu0uJA3wXWEymqzdMTYWS8G1L4ABSeZePUaM9lVJ8/exec";

    // Variables globales
    var pers_dt = [];
    var pers_js = [];
    var titulos_dt = [];
    var datosFiltrados = [];
    var filasPorPagina = 10;
    var paginaActual = 1;
    var categoriaSeleccionada = 'all';
    
    // Variables para los gráficos
    var tipoTrabajoChart, tipoContratoChart, departamentoChart, turnoChart, edadChart;
    var departmentCharts = {}; // Para almacenar gráficos por departamento

    // Cargar datos al iniciar
    window.onload = function() {
      load_Personal_DIMAO();
    };

    // ************** Funciones de UI **************
    function mostrarOverlay(msg) {
      document.getElementById("overlayMessage").innerText = msg;
      const overlay = new bootstrap.Modal(document.getElementById('overlay'));
      overlay.show();
    }

    function ocultarOverlay() { 
      const overlay = bootstrap.Modal.getInstance(document.getElementById('overlay'));
      overlay.hide();
    }

    // ************** Función principal de lectura **************
    function load_Personal_DIMAO() {
      pers_dt = [];
      pers_js = [];
      mostrarOverlay("Leyendo datos desde el servidor...");
      
      fetch(WEB_PERSONAL + "?h=DIMAO")
        .then(response => response.json())
        .then(data => {
          pers_dt = data.pers_dt || [];
          pers_js = convertir_Formato_MySQL(pers_dt);
          titulos_dt = Object.keys(pers_js[0] || {});
          ocultarOverlay();
          continuar();
        })
        .catch(error => {
          console.error("Error en la comunicación con el servidor: ", error);
          ocultarOverlay();
          alert("Error en la comunicación con el servidor: " + error);
        });
    }

    function convertir_Formato_MySQL(baul) {
      if (!Array.isArray(baul) || baul.length < 2) {
        return [];
      }
      
      const baul_js = [];
      const titulos = baul[0];
      
      for (let ii = 1; ii < baul.length; ii++) {
        const fila = baul[ii];
        const objeto = {};
        
        for (let jj = 0; jj < titulos.length; jj++) {
          objeto[titulos[jj]] = fila[jj];
        }
        
        baul_js.push(objeto);
      }
      
      return baul_js;
    }

    // ***************************************************************
    function continuar() {
      // Inicializar datos filtrados
      datosFiltrados = [...pers_js];
      
      // Actualizar estadísticas generales
      actualizarEstadisticasGenerales();
      
      // Generar estadísticas por tipo de trabajo
      generarEstadisticasTipoTrabajo();
      
      // Generar gráficos
      generarGraficos();
      
      // Generar mini lista
      generarMiniLista();
      
      // Generar análisis por departamento
      generarAnalisisDepartamentos();
      
      // Generar estadísticas por departamento
      generarEstadisticasDepartamentos();
      
      // Generar estadísticas por tipo de contrato
      generarEstadisticasContratos();
    }

    function actualizarEstadisticasGenerales() {
      // Actualizar total de personal
      document.getElementById('totalPersonal').textContent = pers_js.length;
      
      // Calcular total de departamentos únicos
      const departamentosUnicos = [...new Set(pers_js.map(item => item.DEPARTAMENTO))].filter(Boolean);
      document.getElementById('totalDepartamentos').textContent = departamentosUnicos.length;
      
      // Calcular total de tipos de contrato únicos
      const contratosUnicos = [...new Set(pers_js.map(item => item.MOD_CONTR))].filter(Boolean);
      document.getElementById('totalContratos').textContent = contratosUnicos.length;
      
      // Calcular total de tipos de trabajo únicos
      const trabajosUnicos = [...new Set(pers_js.map(item => item.TIPO_TRABAJO))].filter(Boolean);
      document.getElementById('totalTrabajos').textContent = trabajosUnicos.length;
    }

    function generarEstadisticasTipoTrabajo() {
      const statsContainer = document.getElementById('statsContainer');
      if (statsContainer) {
        statsContainer.innerHTML = '';
        
        // Calcular estadísticas por tipo de trabajo
        const tiposTrabajo = contarValoresUnicos('TIPO_TRABAJO');
        const totalRegistros = pers_js.length;
        
        // Crear tarjetas para cada tipo de trabajo
        tiposTrabajo.labels.forEach((label, index) => {
          const valor = tiposTrabajo.valores[index];
          const porcentaje = ((valor / totalRegistros) * 100).toFixed(1);
          
          const statCard = document.createElement('div');
          statCard.className = 'col-md-3 mb-3';
          statCard.innerHTML = `
            <div class="card stat-card ${categoriaSeleccionada === label ? 'active' : ''}" 
                 onclick="filtrarPorTipoTrabajo('${label}')">
              <div class="card-body text-center">
                <h6 class="card-title">
                  ${label} 
                  <span class="badge bg-primary tipo-trabajo-badge">${label.substring(0, 3)}</span>
                </h6>
                <h2 class="text-primary">${valor}</h2>
                <p class="text-success mb-0">${porcentaje}%</p>
              </div>
            </div>
          `;
          
          statsContainer.appendChild(statCard);
        });
        
        // Tarjeta para el total
        const totalCard = document.createElement('div');
        totalCard.className = 'col-md-3 mb-3';
        totalCard.innerHTML = `
          <div class="card stat-card ${categoriaSeleccionada === 'all' ? 'active' : ''}" 
               onclick="mostrarTodos()">
            <div class="card-body text-center">
              <h6 class="card-title">TOTAL PERSONAL</h6>
              <h2 class="text-dark">${totalRegistros}</h2>
              <p class="text-success mb-0">100%</p>
            </div>
          </div>
        `;
        
        statsContainer.appendChild(totalCard);
      }
    }

    function generarGraficos() {
      // Destruir gráficos existentes si los hay
      if (tipoTrabajoChart) tipoTrabajoChart.destroy();
      if (tipoContratoChart) tipoContratoChart.destroy();
      if (departamentoChart) departamentoChart.destroy();
      if (turnoChart) turnoChart.destroy();
      if (edadChart) edadChart.destroy();
      
      // Preparar datos para los gráficos
      const datosTipoTrabajo = contarValoresUnicos('TIPO_TRABAJO');
      const datosTipoContrato = contarValoresUnicos('MOD_CONTR');
      const datosDepartamento = contarValoresUnicos('DEPARTAMENTO');
      const datosTurno = contarValoresUnicos('TURNO');
      const datosEdad = calcularRangosEdad();
      
      // Colores para los gráficos
      const colores = [
        '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
        '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
      ];
      
      // Gráfico de Tipo de Trabajo
      const ctxTipoTrabajo = document.getElementById('tipoTrabajoChart').getContext('2d');
      tipoTrabajoChart = new Chart(ctxTipoTrabajo, {
        type: 'doughnut',
        data: {
          labels: datosTipoTrabajo.labels,
          datasets: [{
            data: datosTipoTrabajo.valores,
            backgroundColor: colores,
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          },
          onClick: (evt, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const label = datosTipoTrabajo.labels[index];
              filtrarPorTipoTrabajo(label);
            }
          }
        }
      });
      
      // Gráfico de Tipo de Contrato
      const ctxTipoContrato = document.getElementById('tipoContratoChart').getContext('2d');
      tipoContratoChart = new Chart(ctxTipoContrato, {
        type: 'doughnut',
        data: {
          labels: datosTipoContrato.labels,
          datasets: [{
            data: datosTipoContrato.valores,
            backgroundColor: colores,
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
      
      // Gráfico de Departamento
      const ctxDepartamento = document.getElementById('departamentoChart').getContext('2d');
      departamentoChart = new Chart(ctxDepartamento, {
        type: 'bar',
        data: {
          labels: datosDepartamento.labels.slice(0, 8), // Mostrar solo los primeros 8
          datasets: [{
            label: 'Personal por Departamento',
            data: datosDepartamento.valores.slice(0, 8),
            backgroundColor: colores,
            borderColor: colores.map(color => color.replace('0.8', '1')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
      
      // Gráfico de Turno
      const ctxTurno = document.getElementById('turnoChart').getContext('2d');
      turnoChart = new Chart(ctxTurno, {
        type: 'pie',
        data: {
          labels: datosTurno.labels,
          datasets: [{
            data: datosTurno.valores,
            backgroundColor: colores,
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
      
      // Gráfico de Rango de Edad
      const ctxEdad = document.getElementById('edadChart').getContext('2d');
      edadChart = new Chart(ctxEdad, {
        type: 'bar',
        data: {
          labels: datosEdad.labels,
          datasets: [{
            label: 'Cantidad de Personas',
            data: datosEdad.valores,
            backgroundColor: '#3498db',
            borderColor: '#2980b9',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Cantidad de Personas'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Rango de Edad'
              }
            }
          }
        }
      });
    }
    
    function calcularRangosEdad() {
      // Verificar si existe la columna FECHA_NACIMIENTO
      const tieneFechaNacimiento = titulos_dt.includes('FECH_NACIM');
      
      let edades = [];
      
      if (tieneFechaNacimiento) {
        // Calcular edades a partir de la fecha de nacimiento
        const hoy = new Date();
        edades = pers_js.map(persona => {
          if (persona.FECH_NACIM) {
            // Convertir la fecha de nacimiento a objeto Date
            const fechaStr = persona.FECH_NACIM.toString().trim();
            
            // Para formato "1964-09-01"
            if (fechaStr.includes('-')) {
              const partes = fechaStr.split('-');
              if (partes.length === 3) {
                // Crear fecha correctamente - el mes en JavaScript es 0-based (0=Enero, 1=Febrero, etc.)
                const fechaNac = new Date(partes[0], partes[1] - 1, partes[2]);
                
                // Verificar si la fecha es válida
                if (isNaN(fechaNac.getTime())) {
                  console.warn('Fecha de nacimiento inválida:', persona.FECH_NACIM);
                  return null;
                }
                
                // Calcular edad
                const edad = hoy.getFullYear() - fechaNac.getFullYear();
                const mes = hoy.getMonth() - fechaNac.getMonth();
                
                // Ajustar si aún no ha cumplido años este año
                if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                  return edad - 1;
                }
                return edad;
              }
            }
            console.warn('Formato de fecha no reconocido:', persona.FECH_NACIM);
            return null;
          }
          return null;
        }).filter(edad => edad !== null && !isNaN(edad) && edad > 0 && edad < 120);
      } else {
        // Generar edades aleatorias para demostración
        console.log('No se encontró columna FECH_NACIM, usando datos de ejemplo');
        edades = pers_js.map(() => Math.floor(Math.random() * 40) + 20); // Edades entre 20 y 60
      }
      
      console.log('Edades calculadas:', edades);
      
      // Definir rangos de edad
      const rangos = [
        { min: 18, max: 25, label: '18-25' },
        { min: 26, max: 35, label: '26-35' },
        { min: 36, max: 45, label: '36-45' },
        { min: 46, max: 55, label: '46-55' },
        { min: 56, max: 65, label: '56-65' },
        { min: 66, max: 75, label: '66-75' },
        { min: 76, max: 100, label: '76+' }
      ];
      
      // Contar personas en cada rango
      const conteoRangos = rangos.map(rango => {
        return edades.filter(edad => edad >= rango.min && edad <= rango.max).length;
      });
      
      return {
        labels: rangos.map(rango => rango.label),
        valores: conteoRangos
      };
    }
    
    function generarMiniLista() {
      const miniList = document.getElementById('miniList');
      miniList.innerHTML = '';
      
      let datosAMostrar = datosFiltrados;
      
      // Si hay una categoría seleccionada, filtrar por ella
      if (categoriaSeleccionada !== 'all') {
        datosAMostrar = datosFiltrados.filter(item => 
          item.TIPO_TRABAJO === categoriaSeleccionada
        );
      }
      
      // Limitar a 15 elementos para la mini lista
      const datosLimitados = datosAMostrar.slice(0, 15);
      
      if (datosLimitados.length === 0) {
        miniList.innerHTML = '<div class="p-3 text-center text-muted">No hay datos para mostrar</div>';
        return;
      }
      
      datosLimitados.forEach(persona => {
        const listItem = document.createElement('div');
        listItem.className = 'border-bottom p-3';
        
        listItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${persona.NOMBRES || ''} ${persona.AP_PATERNO || ''}</strong>
              <div class="text-muted small">${persona.RUT || ''} • ${persona.DEPARTAMENTO || ''}</div>
            </div>
            <span class="badge bg-light text-dark">${persona.TIPO_TRABAJO || ''}</span>
          </div>
        `;
        
        miniList.appendChild(listItem);
      });
      
      // Actualizar título
      document.getElementById('currentCategory').textContent = 
        categoriaSeleccionada === 'all' ? 'Todos' : categoriaSeleccionada;
    }
    
    function contarValoresUnicos(columna) {
      const conteo = {};
      
      pers_js.forEach(item => {
        const valor = item[columna] || 'No especificado';
        conteo[valor] = (conteo[valor] || 0) + 1;
      });
      
      // Ordenar por frecuencia (mayor a menor)
      const ordenado = Object.entries(conteo)
        .sort((a, b) => b[1] - a[1]);
      
      return {
        labels: ordenado.map(item => item[0]),
        valores: ordenado.map(item => item[1])
      };
    }

    function filtrarPorTipoTrabajo(tipo) {
      categoriaSeleccionada = tipo;
      
      // Filtrar datos
      if (tipo === 'all') {
        datosFiltrados = [...pers_js];
      } else {
        datosFiltrados = pers_js.filter(item => 
          item.TIPO_TRABAJO === tipo
        );
      }
      
      // Reiniciar paginación
      paginaActual = 1;
      
      // Actualizar interfaz
      generarEstadisticasTipoTrabajo();
      generarMiniLista();
    }
    
    function mostrarTodos() {
      filtrarPorTipoTrabajo('all');
    }

    // Función para generar análisis por departamento
    function generarAnalisisDepartamentos() {
      const accordion = document.getElementById('departamentosAccordion');
      accordion.innerHTML = '';
      
      // Obtener departamentos únicos
      const departamentos = [...new Set(pers_js.map(item => item.DEPARTAMENTO))].filter(Boolean);
      
      // Colores para gráficos
      const colores = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c', '#d35400'];
      
      departamentos.forEach((departamento, index) => {
        // Filtrar personal por departamento
        const personalDepartamento = pers_js.filter(item => item.DEPARTAMENTO === departamento);
        
        // Calcular estadísticas para este departamento
        const totalPersonal = personalDepartamento.length;
        const tiposTrabajo = contarValoresUnicosPorDepartamento('TIPO_TRABAJO', departamento);
        const tiposContrato = contarValoresUnicosPorDepartamento('MOD_CONTR', departamento);
        const turnos = contarValoresUnicosPorDepartamento('TURNO', departamento);
        
        // Crear acordeón para este departamento
        const accordionItem = document.createElement('div');
        accordionItem.className = 'accordion-item';
        accordionItem.innerHTML = `
          <h2 class="accordion-header" id="heading${index}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                    data-bs-target="#collapse${index}" aria-expanded="false" 
                    aria-controls="collapse${index}">
              <strong>${departamento}</strong> 
              <span class="badge bg-primary ms-2">${totalPersonal} personas</span>
            </button>
          </h2>
          <div id="collapse${index}" class="accordion-collapse collapse" 
               aria-labelledby="heading${index}" data-bs-parent="#departamentosAccordion">
            <div class="accordion-body">
              <div class="row">
                <div class="col-md-4">
                  <h6>Distribución por Tipo de Trabajo</h6>
                  <div class="department-chart">
                    <canvas id="chartTrabajo${index}"></canvas>
                  </div>
                </div>
                <div class="col-md-4">
                  <h6>Distribución por Tipo de Contrato</h6>
                  <div class="department-chart">
                    <canvas id="chartContrato${index}"></canvas>
                  </div>
                </div>
                <div class="col-md-4">
                  <h6>Distribución por Turno</h6>
                  <div class="department-chart">
                    <canvas id="chartTurno${index}"></canvas>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <h6>Personal del Departamento</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-striped">
                    <thead>
                      <tr>
                        <th>Nombre</th>
                        <th>RUT</th>
                        <th>Tipo Trabajo</th>
                        <th>Contrato</th>
                        <th>Turno</th>
                      </tr>
                    </thead>
                    <tbody id="tablaPersonal${index}">
                      <!-- Datos del personal se cargarán aquí -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
        
        accordion.appendChild(accordionItem);
        
        // Generar gráficos para este departamento
        setTimeout(() => {
          generarGraficosDepartamento(departamento, index, tiposTrabajo, tiposContrato, turnos, colores);
          generarTablaPersonal(departamento, index);
        }, 100);
      });
    }
    
    function contarValoresUnicosPorDepartamento(columna, departamento) {
      const personalDepartamento = pers_js.filter(item => item.DEPARTAMENTO === departamento);
      return contarValoresUnicosEnArray(columna, personalDepartamento);
    }
    
    function contarValoresUnicosEnArray(columna, array) {
      const conteo = {};
      
      array.forEach(item => {
        const valor = item[columna] || 'No especificado';
        conteo[valor] = (conteo[valor] || 0) + 1;
      });
      
      const ordenado = Object.entries(conteo)
        .sort((a, b) => b[1] - a[1]);
      
      return {
        labels: ordenado.map(item => item[0]),
        valores: ordenado.map(item => item[1])
      };
    }
    
    function generarGraficosDepartamento(departamento, index, tiposTrabajo, tiposContrato, turnos, colores) {
      // Gráfico de Tipo de Trabajo
      const ctxTrabajo = document.getElementById(`chartTrabajo${index}`).getContext('2d');
      departmentCharts[`trabajo${index}`] = new Chart(ctxTrabajo, {
        type: 'doughnut',
        data: {
          labels: tiposTrabajo.labels,
          datasets: [{
            data: tiposTrabajo.valores,
            backgroundColor: colores,
            borderColor: '#fff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      
      // Gráfico de Tipo de Contrato
      const ctxContrato = document.getElementById(`chartContrato${index}`).getContext('2d');
      departmentCharts[`contrato${index}`] = new Chart(ctxContrato, {
        type: 'pie',
        data: {
          labels: tiposContrato.labels,
          datasets: [{
            data: tiposContrato.valores,
            backgroundColor: colores,
            borderColor: '#fff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      
      // Gráfico de Turno
      const ctxTurno = document.getElementById(`chartTurno${index}`).getContext('2d');
      departmentCharts[`turno${index}`] = new Chart(ctxTurno, {
        type: 'bar',
        data: {
          labels: turnos.labels,
          datasets: [{
            label: 'Cantidad',
            data: turnos.valores,
            backgroundColor: colores[0],
            borderColor: colores[0],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    function generarTablaPersonal(departamento, index) {
      const tablaBody = document.getElementById(`tablaPersonal${index}`);
      const personalDepartamento = pers_js.filter(item => item.DEPARTAMENTO === departamento);
      
      // Limitar a 10 registros para no hacer la tabla demasiado larga
      const personalMostrar = personalDepartamento.slice(0, 10);
      
      tablaBody.innerHTML = '';
      
      personalMostrar.forEach(persona => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${persona.NOMBRES || ''} ${persona.AP_PATERNO || ''}</td>
          <td>${persona.RUT || ''}</td>
          <td><span class="badge bg-light text-dark">${persona.TIPO_TRABAJO || ''}</span></td>
          <td>${persona.MOD_CONTR || ''}</td>
          <td>${persona.TURNO || ''}</td>
        `;
        tablaBody.appendChild(fila);
      });
      
      // Si hay más de 10 registros, mostrar un mensaje
      if (personalDepartamento.length > 10) {
        const filaInfo = document.createElement('tr');
        filaInfo.innerHTML = `
          <td colspan="5" class="text-center text-muted">
            ... y ${personalDepartamento.length - 10} personas más
          </td>
        `;
        tablaBody.appendChild(filaInfo);
      }
    }

    function generarEstadisticasDepartamentos() {
      const departamentosStats = document.getElementById('departamentosStats');
      departamentosStats.innerHTML = '';
      
      const datosDepartamentos = contarValoresUnicos('DEPARTAMENTO');
      const totalRegistros = pers_js.length;
      
      // Colores para las tarjetas
      const colores = [
        '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
        '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad',
        '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'
      ];
      
      datosDepartamentos.labels.forEach((label, index) => {
        const valor = datosDepartamentos.valores[index];
        const porcentaje = ((valor / totalRegistros) * 100).toFixed(1);
        
        const card = document.createElement('div');
        card.className = 'stats-card';
        card.style.backgroundColor = colores[index % colores.length];
        
        card.innerHTML = `
          <div class="number">${valor}</div>
          <div class="label">${label}</div>
          <div class="small mt-1">${porcentaje}%</div>
        `;
        
        departamentosStats.appendChild(card);
      });
    }

    function generarEstadisticasContratos() {
      const contratosStats = document.getElementById('contratosStats');
      contratosStats.innerHTML = '';
      
      const datosContratos = contarValoresUnicos('MOD_CONTR');
      const totalRegistros = pers_js.length;
      
      // Colores para las tarjetas
      const colores = [
        '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6',
        '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
      ];
      
      datosContratos.labels.forEach((label, index) => {
        const valor = datosContratos.valores[index];
        const porcentaje = ((valor / totalRegistros) * 100).toFixed(1);
        
        const card = document.createElement('div');
        card.className = 'stats-card';
        card.style.backgroundColor = colores[index % colores.length];
        
        card.innerHTML = `
          <div class="number">${valor}</div>
          <div class="label">${label}</div>
          <div class="small mt-1">${porcentaje}%</div>
        `;
        
        contratosStats.appendChild(card);
      });
    }
  </script>
</body>
</html>